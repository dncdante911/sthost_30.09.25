<!DOCTYPE html>
<html>
<head>
    <title>–ü–∞–Ω–µ–ª—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ - StormHosting</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .header { background: #667eea; color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        .alert { padding: 15px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .urgent { background: #ffebee; border-left: 5px solid #f44336; animation: blink 2s infinite; }
        .normal { background: #e8f5e8; border-left: 5px solid #4caf50; }
        .timestamp { color: #666; font-size: 12px; }
        .counter { background: #333; color: white; padding: 5px 10px; border-radius: 15px; display: inline-block; margin-left: 10px; }
        @keyframes blink { 0%, 50% { opacity: 1; } 25%, 75% { opacity: 0.7; } }
        .sound-toggle { background: #4caf50; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéß –ü–∞–Ω–µ–ª—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ StormHosting</h1>
        <p>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥ | –ü–æ—Å–ª–µ–¥–Ω—è—è –ø—Ä–æ–≤–µ—Ä–∫–∞: <span id="lastCheck">-</span></p>
        <button class="sound-toggle" id="soundToggle" onclick="toggleSound()">üîä –ó–≤—É–∫ –≤–∫–ª—é—á–µ–Ω</button>
        <span class="counter" id="urgentCounter">–°—Ä–æ—á–Ω—ã—Ö: 0</span>
    </div>
    
    <div id="notifications"></div>
    
    <script>
        let lastMessageTime = Math.floor(Date.now() / 1000) - 3600; // –ß–∞—Å –Ω–∞–∑–∞–¥
        let soundEnabled = true;
        let urgentCount = 0;
        let shownMessages = new Set();
        
        function updateLastCheck() {
            document.getElementById('lastCheck').textContent = new Date().toLocaleTimeString();
        }
        
        function checkMessages() {
            updateLastCheck();
            
            fetch('/chat/get-notifications.php?since=' + lastMessageTime)
                .then(response => response.json())
                .then(data => {
                    if (data.messages && data.messages.length > 0) {
                        data.messages.forEach(msg => {
                            // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Å–æ–æ–±—â–µ–Ω–∏—è
                            const msgId = msg.time + '_' + msg.message.substring(0, 20);
                            
                            if (!shownMessages.has(msgId)) {
                                shownMessages.add(msgId);
                                showNotification(msg);
                                
                                if (msg.urgent) {
                                    urgentCount++;
                                    updateUrgentCounter();
                                    if (soundEnabled) playUrgentSound();
                                } else {
                                    if (soundEnabled) playNormalSound();
                                }
                            }
                        });
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
                        lastMessageTime = Math.floor(Date.now() / 1000);
                    }
                })
                .catch(error => console.error('–û—à–∏–±–∫–∞:', error));
        }
        
        function showNotification(msg) {
            const div = document.createElement('div');
            div.className = 'alert ' + (msg.urgent ? 'urgent' : 'normal');
            div.innerHTML = `
                <strong>${msg.urgent ? 'üö® –°–†–û–ß–ù–û - –ó–ê–ü–†–û–° –û–ü–ï–†–ê–¢–û–†–ê!' : 'üí¨ –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ'}</strong>
                <div class="timestamp">${msg.time}</div>
                <div style="font-size: 16px; margin: 10px 0;">"${msg.message}"</div>
                ${msg.urgent ? '<div style="color: #d32f2f; font-weight: bold;">‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è —Å–≤—è–∑–∞—Ç—å—Å—è —Å –∫–ª–∏–µ–Ω—Ç–æ–º!</div>' : ''}
            `;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞
            const notifications = document.getElementById('notifications');
            notifications.insertBefore(div, notifications.firstChild);
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            while (notifications.children.length > 10) {
                notifications.removeChild(notifications.lastChild);
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±—Ä–∞—É–∑–µ—Ä–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            if (msg.urgent && Notification.permission === 'granted') {
                new Notification('üö® StormHosting: –ö–ª–∏–µ–Ω—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞!', {
                    body: msg.message,
                    icon: '/favicon.ico',
                    requireInteraction: true
                });
            }
        }
        
        function playUrgentSound() {
            if (!soundEnabled) return;
            
            const context = new AudioContext();
            // –¢—Ä–æ–π–Ω–æ–π —Å–∏–≥–Ω–∞–ª –¥–ª—è —Å—Ä–æ—á–Ω—ã—Ö
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    const oscillator = context.createOscillator();
                    const gainNode = context.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(context.destination);
                    
                    oscillator.frequency.value = 800;
                    gainNode.gain.setValueAtTime(0.3, context.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, context.currentTime + 0.5);
                    
                    oscillator.start(context.currentTime);
                    oscillator.stop(context.currentTime + 0.5);
                }, i * 600);
            }
        }
        
        function playNormalSound() {
            if (!soundEnabled) return;
            
            const context = new AudioContext();
            const oscillator = context.createOscillator();
            const gainNode = context.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(context.destination);
            
            oscillator.frequency.value = 400;
            gainNode.gain.setValueAtTime(0.1, context.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, context.currentTime + 0.3);
            
            oscillator.start(context.currentTime);
            oscillator.stop(context.currentTime + 0.3);
        }
        
        function toggleSound() {
            soundEnabled = !soundEnabled;
            const btn = document.getElementById('soundToggle');
            btn.textContent = soundEnabled ? 'üîä –ó–≤—É–∫ –≤–∫–ª—é—á–µ–Ω' : 'üîá –ó–≤—É–∫ –≤—ã–∫–ª—é—á–µ–Ω';
            btn.style.background = soundEnabled ? '#4caf50' : '#f44336';
        }
        
        function updateUrgentCounter() {
            document.getElementById('urgentCounter').textContent = '–°—Ä–æ—á–Ω—ã—Ö: ' + urgentCount;
        }
        
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        if (Notification.permission === 'default') {
            Notification.requestPermission();
        }
        
        // –ü–µ—Ä–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–∞–∑—É
        checkMessages();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥
        setInterval(checkMessages, 15000);
        
        console.log('–ü–∞–Ω–µ–ª—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞');
    </script>
</body>
</html>